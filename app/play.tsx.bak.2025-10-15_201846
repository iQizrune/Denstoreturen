import React, { useEffect, useState } from 'react';
import { conductor } from '@/src/engine/conductor';
import { BANKS } from '@/src/banks/local';
import { POINTS_PER_CORRECT } from '@/src/config/game';
import { View } from 'react-native';
import { Link } from 'expo-router';
import { Pressable, Text } from 'react-native';
import { useRouter, useLocalSearchParams } from 'expo-router';
export default function PlayScreen() {
  const [snap, setSnap] = useState(conductor.getSnapshot());
  const meters = snap.meters;
  const [Panel, setPanel] = useState<any>(null);
  const [answered, setAnswered] = useState(false);
  const router = useRouter();
const { cat } = useLocalSearchParams<{ cat?: string }>();
const total = (BANKS[(cat as string) || "general"]?.length) ?? 0;
    const [correct, setCorrect] = useState(0);

  useEffect(() => {
    let alive = true;
    const off = conductor.on(next => setSnap(next));
conductor.start((cat as string) || undefined);
setCorrect(0);
        setAnswered(false);

    console.log('[phase] play: mount');
    import('@/src/partials/PlayingPanels')
      .then((m: any) => { if (alive) setPanel(() => m.default || null); })
      .catch(() => {});
    return () => { off(); };
  }, []);
  if (!Panel) return <View style={{ flex: 1 }} />;
return (
  <>
  <>
    <Panel bankKey={(cat as string) || "general"}
  onCorrect={() => { conductor.answer(true); setAnswered(true); setCorrect(c => c + 1); }}
  onWrong={() => { conductor.answer(false); setAnswered(true); }}
  onFinished={() => { try { router.replace(`/results?score=${meters}&correct=${correct}&total=${total}&cat=${(cat as string) || "general"}`); } catch {} }}
/>

    <Text>Fase: {snap.phase}</Text>
    <Text>Meter: {meters}</Text>
    <Pressable onPress={() => { conductor.finish(); router.replace("/results"); }} style={{ marginTop: 12, backgroundColor: '#e5e7eb', padding: 12, borderRadius: 8 }}>
      <Text>Avslutt n√•</Text>
    </Pressable>
    <Pressable disabled={!answered} onPress={() => { conductor.finish(); router.replace("/results"); }} style={{ marginTop: 12, opacity: answered ? 1 : 0.5 }}>
      <Text>Fullf√∏r spill ‚Üí</Text>
    </Pressable>

    <Link href="/home">Til hjem</Link>
    <View style={{ position: 'absolute', bottom: 16, right: 16 }}>
      <Link href="/kart" asChild>
        <Pressable style={{ backgroundColor: '#111', paddingVertical: 10, paddingHorizontal: 12, borderRadius: 999, borderWidth: 1, borderColor: '#333' }}>
          <Text style={{ color: '#60a5fa', fontWeight: '700' }}>üó∫Ô∏è</Text>
        </Pressable>
      </Link>
    </View>

  </>
);

}
